<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portal Inventario || Series </title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="menu-page formulario-traspaso">
    <div class="content">
  <div class="contenedor">
    
    <a href="/Stock" class="volver">
      <i class="fas fa-arrow-left"></i> Volver a Stock Contrata
    </a>

    <h2><i class="fas fa-barcode"></i> Control de Series</h2>

    <div class="acciones-tabla acciones-series">
      <button onclick="descargarExcelSeries()">
        <i class="fas fa-file-excel"></i> Descargar Excel
      </button>
      
    <input type="file" id="excelInput" accept=".xlsx" style="display:none;" onchange="confirmarCargaExcel(this.files[0])">
    <button onclick="mostrarMenuCarga()">
      <i class="fas fa-upload"></i> Actualizar Datos
    </button>
      
      <button onclick="alternarOrden()">
      <i class="fas fa-sort-amount-down-alt"></i> Ordenar por Antiguamiento
      </button>
          </div>
      <div class="search-bar-paginacion">
  <input type="text" id="searchInput" placeholder="Buscar por código, descripción o zona..." />
  <div class="paginacion">
    <button id="prevPage" onclick="cambiarPagina(-1)">Anterior</button>
    <span id="pageIndicator">Página 1</span>
    <button id="nextPage" onclick="cambiarPagina(1)">Siguiente</button>
  </div>
</div>

      <div class="tabla-scroll">
      <table id="tablaSeries">
        <thead>
          <tr>
            <th>Código</th>
            <th>Descripción</th>
            <th>Centro</th>
            <th>Almacén</th>
            <th>Lote</th>
            <th>N° Serie</th>
            <th>Empresa</th>
            <th>Fecha Ingreso</th>
            <th>Fecha Compra</th>
            <th>Estado Contrata</th>            
            <th>SOT</th>      
            <th>Cliente</th>       
            <th>ID Devolución/Traspaso</th> 
            <th>Fecha Estado Contrata</th>
            <th>Comentario Contrata</th>
            <th>Antiguamiento</th>
            <th>Antiguamiento Compra</th>
            <th>Estado Soporte</th>
            <th>Comentario Soporte</th>
            <th>Fecha Estado Soporte</th>
          </tr>
        </thead>
        <tbody id="series-body">
          <!-- Contenido dinámico -->
        </tbody>
      </table>
    </div>
  </div>
    </div>

<div id="loader" class="loader-overlay" style="display: none;">
  <div class="spinner"></div>
</div>

<script>
function formatearFechaSegura(fechaString) {
  if (!fechaString) return '';
  const [anio, mes, dia] = fechaString.split('-');
  return `${dia}/${mes}/${anio}`;
}

  function calcularAntiguamiento(fechaString) {
  if (!fechaString) return null;
  const fechaIngreso = new Date(fechaString);
  const hoy = new Date();
  const diferenciaMs = hoy - fechaIngreso;
  const dias = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24));
  return dias;
}
</script>
  
<script>
    const supabaseUrl = 'https://bsrtuievwjtzwejuxqee.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzcnR1aWV2d2p0endlanV4cWVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NTEyNjYsImV4cCI6MjA2NDEyNzI2Nn0.A9tCs-Zi-7jw5LUFs7ViIR2vHb9tNMj6c7YeeNOdmWI';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // 🔽⬅️ INICIO DE SCRIPT
let paginaActual = 0;
const tamañoPagina = 500;
let filtroActual = '';
let modoOrden = 'empresa'; // valores posibles: 'empresa' o 'antiguamiento'
  
   async function cargarSeries(filtro = '', pagina = 0) {
  mostrarLoader();
  const tbody = document.getElementById("series-body");
  tbody.innerHTML = "";

  filtroActual = filtro;
  paginaActual = pagina;

  const rolUsuario = localStorage.getItem("rol");
const empresaUsuario = (localStorage.getItem("empresa") || '').toUpperCase();
     
let queryBase = supabase
  .from('series_contrata')
  .select('*', { count: 'exact' });

if (rolUsuario === "Contratista") {
  queryBase = queryBase.eq("empresa", empresaUsuario);
}
  
  if (modoOrden === 'empresa') {
    queryBase = queryBase.order('empresa', { ascending: true });
  } else {
    queryBase = queryBase.order('fecha_ingreso', { ascending: true }); // más antiguos primero
  }
  
  queryBase = queryBase.range(pagina * tamañoPagina, (pagina + 1) * tamañoPagina - 1);

  if (filtro.trim() !== '') {
    queryBase = queryBase.or(
      `codigo.ilike.%${filtro}%,descripcion.ilike.%${filtro}%,lote.ilike.%${filtro}%,nro_serie.ilike.%${filtro}%,cliente.ilike.%${filtro}%,empresa.ilike.%${filtro}%`
    );
  }
  const { data, error, count } = await queryBase;

  if (error) {
    console.error("Error al cargar series:", error);
    ocultarLoader();
    return;
  }

  if (!data || data.length === 0) {
    const fila = document.createElement("tr");
    fila.innerHTML = `<td colspan="18" style="text-align:center; color:gray;">No se encontraron resultados.</td>`;
    tbody.appendChild(fila);
    ocultarLoader();
    actualizarControlesPaginacion(0, 0); // limpiar
    return;
  }
 
  data.forEach(serie => {
    const diasAntiguos = calcularAntiguamiento(serie.fecha_ingreso);
    let claseColor = '';
    if (diasAntiguos > 90) claseColor = 'rojo-suave';
    else if (diasAntiguos > 60) claseColor = 'naranja-suave';
    else claseColor = 'verde-suave';

    const fila = document.createElement("tr");
   fila.innerHTML = `
  <td>${serie.codigo || ''}</td>
  <td>${serie.descripcion || ''}</td>
  <td>${serie.centro || ''}</td>
  <td>${serie.almacen || ''}</td>
  <td>${serie.lote || ''}</td>
  <td>${serie.nro_serie || ''}</td>
  <td>${serie.empresa || ''}</td>
  <td>${formatearFechaSegura(serie.fecha_ingreso)}</td>
  <td>${formatearFechaSegura(serie.fecha_compra)}</td>
<td>${(serie.estado_contrata || '').toUpperCase()}</td>
  <td>${serie.proyecto_sot || ''}</td>
  <td>${serie.cliente || ''}</td>
  <td>${serie.id_devolucion || ''}</td>
  <td>${formatearFechaSegura(serie.fecha_estado_contrata)}</td>
  <td>${serie.comentario_contrata || ''}</td>
  <td class="${claseColor}">${diasAntiguos !== null ? diasAntiguos + ' días' : ''}</td>
  <td class="${claseColor}">${serie.fecha_compra ? calcularAntiguamiento(serie.fecha_compra) + ' días' : ''}</td>
  <td>${serie.estado_soporte || ''}</td>
  <td>${serie.comentario_soporte || ''}</td>
  <td>${formatearFechaSegura(serie.fecha_estado_soporte)}</td>
`;
    tbody.appendChild(fila);
  });

  ocultarLoader();
  actualizarControlesPaginacion(pagina, Math.ceil(count / tamañoPagina));
}
</script>
  
  <script>

 let tiempoEspera = null;

function filtrarTabla() {
  clearTimeout(tiempoEspera);
  const input = document.getElementById("searchInput").value.toLowerCase().trim();
  tiempoEspera = setTimeout(() => {
    cargarSeries(input, 0); // Siempre reiniciar desde página 0 al filtrar
  }, 300);
}


    function alternarOrden() {
  const boton = document.querySelector("button[onclick='alternarOrden()']");

  if (modoOrden === 'empresa') {
    modoOrden = 'antiguamiento';
    boton.innerHTML = '<i class="fas fa-sort-amount-down-alt"></i> Ordenar por Empresa';

    Swal.fire({
      icon: 'info',
      title: 'Ahora ordenando por antigüedad',
      text: 'Los equipos más antiguos aparecerán primero.',
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#f39c12'
    });

  } else {
    modoOrden = 'empresa';
    boton.innerHTML = '<i class="fas fa-sort-amount-down-alt"></i> Ordenar por Antiguamiento';

    Swal.fire({
      icon: 'info',
      title: 'Ahora ordenando por empresa',
      text: 'Las series se mostrarán agrupadas por contratista.',
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#f39c12'
    });
  }

  cargarSeries(filtroActual, 0);
}
  </script>

  <script>
async function descargarExcelSeries() {
  mostrarLoader(); // 👈 Mostrar
  const pageSize = 1000;
  let page = 0;
  let allData = [];
  let fetched = [];

  try {
    do {
      const { data, error } = await supabase
        .from('series_contrata')
        .select('*')
        .range(page * pageSize, (page + 1) * pageSize - 1);

      if (error) throw error;

      fetched = data;
      allData = allData.concat(fetched);
      page++;
    } while (fetched.length === pageSize);

    if (allData.length === 0) {
      console.warn("No se encontraron datos.");
      ocultarLoader();
      return;
    }

    const datos = allData.map(serie => ({
      Código: serie.codigo,
      Descripción: serie.descripcion,
      Centro: serie.centro,
      Almacén: serie.almacen,
      Lote: serie.lote,
      "N° Serie": serie.nro_serie,
      Empresa: serie.empresa,
      "Fecha Ingreso": formatearFechaSegura(serie.fecha_ingreso),
      "Fecha Compra": formatearFechaSegura(serie.fecha_compra),
      "Estado Contrata": serie.estado_contrata,
      SOT: serie.sot,
      Cliente: serie.cliente,
      "ID Devolución/Traspaso": serie.id_devolucion,
      "Fecha Estado Contrata": formatearFechaSegura(serie.fecha_estado_contrata),
      "Comentario Contrata": serie.comentario_contrata,
      Antiguamiento: calcularAntiguamiento(serie.fecha_ingreso) + ' días',      "Estado Soporte": serie.estado_soporte,
      "Antiguamiento Compra": serie.fecha_compra ? calcularAntiguamiento(serie.fecha_compra) + ' días' : '',
      "Comentario Soporte": serie.comentario_soporte,
      "Fecha Estado Soporte": formatearFechaSegura(serie.fecha_estado_soporte)
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(datos);
    XLSX.utils.book_append_sheet(wb, ws, "Series Contrata");
    XLSX.writeFile(wb, "Series_Contrata.xlsx");

          Swal.fire({
    icon: 'success',
    title: 'Excel generado',
    text: 'La descarga ha comenzado.',
    toast: true,
    position: 'bottom-end',
    showConfirmButton: false,
    timer: 2500,
    timerProgressBar: true,
    background: '#1e2022',
    color: '#ffffff',
    iconColor: '#11a24e'
  });

  } catch (error) {
    console.error("Error al exportar Excel:", error);
  } finally {
    ocultarLoader(); // 👈 Siempre ocultar al final
  }
}
  </script>
  
<script>
async function procesarExcelSeries(file) {
  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    let exitos = 0, fallos = 0;

    for (const fila of data) {
      const estado = (fila['Estado Contrata'] || '').toUpperCase();

      const ESTADOS_VALIDOS = ["INSTALADO", "DISPONIBLE", "RESERVADO", "FACTURAR", "TRASPASO", "DEVOLUCION"];

      if (!ESTADOS_VALIDOS.includes(estado)) {
        fallos++;
        continue; // ❌ Ignorar el registro si no es un estado válido
      }
      
      const campos = {
        estado_contrata: estado,
        proyecto_sot: fila.SOT || '-',
        cliente: (fila.Cliente || '-').toString().trim(),
        id_devolucion: fila['ID Devolución/Traspaso'] || '-',
        fecha_estado_contrata: new Date().toISOString().split('T')[0], // ✅ Fecha actual
        comentario_contrata: fila['Comentario Contrata'] || '-',
        estado_soporte: fila['Estado Soporte'] || '-',
        comentario_soporte: fila['Comentario Soporte'] || '-'

      };

      // Validaciones
       if (['INSTALADO', 'RESERVADO'].includes(estado)) {
        if (!fila.SOT || !fila.Cliente || fila.Cliente.toString().trim() === '') { 
          fallos++; 
          continue; 
        }
      }
      
      if (['DEVOLUCION', 'TRASPASO'].includes(estado)) {
        if (!fila['ID Devolución/Traspaso'] || fila['ID Devolución/Traspaso'].toString().trim() === '') { 
          fallos++; 
          continue; 
        }
      }

      // Actualizar en Supabase
      const { error } = await supabase
        .from('series_contrata')
        .update(campos)
        .eq('codigo', fila.Código)
        .eq('centro', fila.Centro)
        .eq('almacen', fila['Almacén'])
        .eq('lote', fila.Lote)
        .eq('nro_serie', fila['N° Serie']);

      if (error) {
        console.error("Error:", error);
        fallos++;
      } else {
        exitos++;
      }
    }

    // Mostrar resultado
    Swal.fire({
      icon: 'info',
      title: 'Carga finalizada',
      html: `✅ Registros actualizados: <b>${exitos}</b><br>❌ Registros omitidos por error o validación: <b>${fallos}</b>`,
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 5000,
      timerProgressBar: true,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#f39c12'
    });

    // Refrescar la vista
    cargarSeries(filtroActual, paginaActual);
  };
  reader.readAsBinaryString(file);
}
</script>

  
<script>
function mostrarMenuCarga() {
  document.getElementById('excelInput').click();
}

function confirmarCargaExcel(file) {
  Swal.fire({
    title: '¿Deseas continuar con la carga?',
    text: 'Se actualizarán los datos según el archivo que selecciones.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Sí, cargar',
    cancelButtonText: 'Cancelar',
    background: '#1e2022',
    color: '#ffffff',
    iconColor: '#f39c12'
  }).then((result) => {
    if (result.isConfirmed) {
      procesarExcelSeries(file);
    }
  });
}
</script>

    
  <script>
  document.addEventListener("DOMContentLoaded", () => cargarSeries(''));
</script>

  <script>
function paginaSiguiente() {
  cargarSeries(filtroActual, paginaActual + 1);
}

function paginaAnterior() {
  if (paginaActual > 0) {
    cargarSeries(filtroActual, paginaActual - 1);
  }
}

function actualizarControlesPaginacion(pagina, totalPaginas) {
  const info = document.getElementById("paginaInfo");
  info.textContent = `Página ${pagina + 1} de ${totalPaginas}`;

  document.querySelector('#paginacion button:nth-child(1)').disabled = pagina <= 0;
  document.querySelector('#paginacion button:nth-child(3)').disabled = pagina + 1 >= totalPaginas;
}
</script>

  <script src="Js/Loader.js"></script>
  <script src="Js/Sesion.js"></script>
</body>
</html>
