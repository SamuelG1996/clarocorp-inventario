<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portal Inventario || Series </title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="menu-page formulario-traspaso">
    <div class="content">
  <div class="contenedor">
    
    <a href="Stock.html" class="volver">
      <i class="fas fa-arrow-left"></i> Volver a Stock Contrata
    </a>

    <h2><i class="fas fa-barcode"></i> Control de Series</h2>

    <div class="acciones-tabla acciones-series">
      <button onclick="descargarExcelSeries()">
        <i class="fas fa-file-excel"></i> Descargar Excel
      </button>
      <button onclick="guardarCambios()">
        <i class="fas fa-save"></i> Grabar
      </button>
    </div>
 <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Buscar por serie, código, lote..." onkeyup="filtrarTabla()">
    </div>
      <div class="tabla-scroll">
      <table id="tablaSeries">
        <thead>
          <tr>
            <th>Código</th>
            <th>Descripción</th>
            <th>Centro</th>
            <th>Almacén</th>
            <th>Lote</th>
            <th>N° Serie</th>
            <th>Empresa</th>
            <th>Fecha Ingreso</th>
            <th>Estado Contrata</th>            
            <th>SOT</th>      
            <th>Cliente</th>       
            <th>ID Devolución/Traspaso</th> 
            <th>Fecha Estado Contrata</th>
            <th>Comentario Contrata</th>
            <th>Antiguamiento</th>
            <th>Estado Soporte</th>
            <th>Comentario Soporte</th>
            <th>Fecha Estado Soporte</th>
          </tr>
        </thead>
        <tbody id="series-body">
          <!-- Contenido dinámico -->
        </tbody>
      </table>
    </div>
  </div>
    </div>


<script>
  function formatearFecha(fechaISO) {
  if (!fechaISO) return '';
  const fecha = new Date(fechaISO);
  return fecha.toLocaleDateString('es-PE');
}

</script>
<script>
    const supabaseUrl = 'https://bsrtuievwjtzwejuxqee.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzcnR1aWV2d2p0endlanV4cWVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NTEyNjYsImV4cCI6MjA2NDEyNzI2Nn0.A9tCs-Zi-7jw5LUFs7ViIR2vHb9tNMj6c7YeeNOdmWI';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    async function cargarSeries() {
      const { data, error } = await supabase.from('series_contrata').select('*');
      const tbody = document.getElementById("series-body");
      tbody.innerHTML = "";

      if (error) {
        console.error("Error al cargar series:", error);
        return;
      }

      data.forEach(serie => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
         <td>${serie.codigo || ''}</td>
        <td>${serie.descripcion || ''}</td>
        <td>${serie.centro || ''}</td>
        <td>${serie.almacen || ''}</td>
        <td>${serie.lote || ''}</td>
        <td>${serie.nro_serie || ''}</td>
        <td>${serie.empresa || ''}</td>
        <td>${formatearFecha(serie.fecha_ingreso)}</td>
        <td>${serie.estado_contrata || ''}</td>
        <td>${serie.sot || ''}</td>
        <td>${serie.cliente || ''}</td>
        <td>${serie.id_devolucion || ''}</td>
        <td>${formatearFecha(serie.fecha_estado_contrata)}</td>
        <td>${serie.comentario_contrata || ''}</td>
        <td>${serie.antiguamiento || ''}</td>
        <td>${serie.estado_soporte || ''}</td>
        <td>${serie.comentario_soporte || ''}</td>
        <td>${formatearFecha(serie.fecha_estado_soporte)}</td>
        `;
        tbody.appendChild(fila);
      });
    }
</script>
  
  <script>
    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

     async function descargarExcelSeries() {
  const { data, error } = await supabase.from('series_contrata').select('*');

  if (error) {
    console.error("Error al obtener datos para Excel:", error);
    return;
  }

  const datos = data.map(serie => ({
    Código: serie.codigo,
    Descripción: serie.descripcion,
    Centro: serie.centro,
    Almacén: serie.almacen,
    Lote: serie.lote,
    "N° Serie": serie.numero_serie,
    Empresa: serie.empresa,
    "Fecha Ingreso": formatearFecha(serie.fecha_ingreso),
    "Estado Contrata": serie.estado_contrata,
    SOT: serie.sot,
    Cliente: serie.cliente,
    "ID Devolución/Traspaso": serie.id_devolucion,
    "Fecha Estado Contrata": formatearFecha(serie.fecha_estado_contrata),
    "Comentario Contrata": serie.comentario_contrata,
    Antiguamiento: serie.antiguamiento,
    "Estado Soporte": serie.estado_soporte,
    "Comentario Soporte": serie.comentario_soporte,
    "Fecha Estado Soporte": formatearFecha(serie.fecha_estado_soporte)
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(datos);
  XLSX.utils.book_append_sheet(wb, ws, "Series FIFO");
  XLSX.writeFile(wb, "Series_FIFO_ClaroCorp.xlsx");
}

    function filtrarTabla() {
      const input = document.getElementById("searchInput").value.toLowerCase().trim();
      const filtros = input.split(/\s+/);
      const filas = document.querySelectorAll("#tablaSeries tbody tr");

      filas.forEach(fila => {
        const textoFila = Array.from(fila.cells).map(td => td.textContent.toLowerCase()).join(" ");
        const coincide = filtros.every(f => textoFila.includes(f));
        fila.style.display = coincide ? "" : "none";
      });
    }
  </script>
  <script>
async function guardarCambios() {
  Swal.fire({
    icon: 'info',
    title: 'Guardar Cambios',
    text: 'Esta función aún no está implementada.',
    position: 'bottom-end',
    showConfirmButton: false,
    timer: 3000,
    background: '#1e2022',
    color: '#ffffff',
    iconColor: '#f39c12'
  });
}
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", cargarSeries);
</script>
  
  <script src="Js/Sesion.js"></script>
</body>
</html>
