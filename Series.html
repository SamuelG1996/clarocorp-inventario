<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portal Inventario || Series </title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="menu-page formulario-traspaso">
    <div class="content">
  <div class="contenedor">
    
    <a href="Stock.html" class="volver">
      <i class="fas fa-arrow-left"></i> Volver a Stock Contrata
    </a>

    <h2><i class="fas fa-barcode"></i> Control de Series</h2>

    <div class="acciones-tabla acciones-series">
      <button onclick="descargarExcelSeries()">
        <i class="fas fa-file-excel"></i> Descargar Excel
      </button>
      
      <button onclick="guardarCambios()">
        <i class="fas fa-save"></i> Grabar
      </button>
      
      <button onclick="alternarOrden()">
      <i class="fas fa-sort-amount-down-alt"></i> Ordenar por Antiguamiento
      </button>

      <input type="file" id="excelInput" accept=".xlsx" onchange="procesarExcelSeries(this.files[0])" style="display:none;">
      <button onclick="document.getElementById('excelInput').click()">
        <i class="fas fa-upload"></i> Cargar Plantilla
      </button>
      
  <div id="paginacion" style="display: inline-block; margin-left: 20px;">
  <button onclick="paginaAnterior()">‚Üê Anterior</button>
  <span id="paginaInfo" style="margin: 0 10px;">P√°gina 1</span>
  <button onclick="paginaSiguiente()">Siguiente ‚Üí</button>
</div>
      
    </div>
 <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Buscar por serie, c√≥digo, lote..." onkeyup="filtrarTabla()">
    </div>
      <div class="tabla-scroll">
      <table id="tablaSeries">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Descripci√≥n</th>
            <th>Centro</th>
            <th>Almac√©n</th>
            <th>Lote</th>
            <th>N¬∞ Serie</th>
            <th>Empresa</th>
            <th>Fecha Ingreso</th>
            <th>Estado Contrata</th>            
            <th>SOT</th>      
            <th>Cliente</th>       
            <th>ID Devoluci√≥n/Traspaso</th> 
            <th>Fecha Estado Contrata</th>
            <th>Comentario Contrata</th>
            <th>Antiguamiento</th>
            <th>Estado Soporte</th>
            <th>Comentario Soporte</th>
            <th>Fecha Estado Soporte</th>
          </tr>
        </thead>
        <tbody id="series-body">
          <!-- Contenido din√°mico -->
        </tbody>
      </table>
    </div>
  </div>
    </div>

<div id="loader" class="loader-overlay" style="display: none;">
  <div class="spinner"></div>
</div>

<script>
function formatearFechaSegura(fechaString) {
  if (!fechaString) return '';
  const [anio, mes, dia] = fechaString.split('-');
  return `${dia}/${mes}/${anio}`;
}

  function calcularAntiguamiento(fechaString) {
  if (!fechaString) return null;
  const fechaIngreso = new Date(fechaString);
  const hoy = new Date();
  const diferenciaMs = hoy - fechaIngreso;
  const dias = Math.floor(diferenciaMs / (1000 * 60 * 60 * 24));
  return dias;
}
</script>
  
<script>
    const supabaseUrl = 'https://bsrtuievwjtzwejuxqee.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzcnR1aWV2d2p0endlanV4cWVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NTEyNjYsImV4cCI6MjA2NDEyNzI2Nn0.A9tCs-Zi-7jw5LUFs7ViIR2vHb9tNMj6c7YeeNOdmWI';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // üîΩ‚¨ÖÔ∏è INICIO DE SCRIPT
let paginaActual = 0;
const tama√±oPagina = 1000;
let filtroActual = '';
let modoOrden = 'empresa'; // valores posibles: 'empresa' o 'antiguamiento'
  
   async function cargarSeries(filtro = '', pagina = 0) {
  mostrarLoader();
  const tbody = document.getElementById("series-body");
  tbody.innerHTML = "";

  filtroActual = filtro;
  paginaActual = pagina;

  let queryBase = supabase
    .from('series_contrata')
    .select('*', { count: 'exact' });
  
  if (modoOrden === 'empresa') {
    queryBase = queryBase.order('empresa', { ascending: true });
  } else {
    queryBase = queryBase.order('fecha_ingreso', { ascending: true }); // m√°s antiguos primero
  }
  
  queryBase = queryBase.range(pagina * tama√±oPagina, (pagina + 1) * tama√±oPagina - 1);

  if (filtro.trim() !== '') {
    queryBase = queryBase.or(
      `codigo.ilike.%${filtro}%,descripcion.ilike.%${filtro}%,lote.ilike.%${filtro}%,nro_serie.ilike.%${filtro}%,cliente.ilike.%${filtro}%,empresa.ilike.%${filtro}%`
    );
  }
  const { data, error, count } = await queryBase;

  if (error) {
    console.error("Error al cargar series:", error);
    ocultarLoader();
    return;
  }

  if (!data || data.length === 0) {
    const fila = document.createElement("tr");
    fila.innerHTML = `<td colspan="18" style="text-align:center; color:gray;">No se encontraron resultados.</td>`;
    tbody.appendChild(fila);
    ocultarLoader();
    actualizarControlesPaginacion(0, 0); // limpiar
    return;
  }
  function agregarKeys(serie) {
    return `
      data-codigo="${serie.codigo}" 
      data-centro="${serie.centro}" 
      data-almacen="${serie.almacen}" 
      data-lote="${serie.lote}" 
      data-nro_serie="${serie.nro_serie}" 
    `;
  }
  data.forEach(serie => {
    const diasAntiguos = calcularAntiguamiento(serie.fecha_ingreso);
    let claseColor = '';
    if (diasAntiguos > 90) claseColor = 'rojo-suave';
    else if (diasAntiguos > 60) claseColor = 'naranja-suave';
    else claseColor = 'verde-suave';

    const fila = document.createElement("tr");
   fila.innerHTML = `
  <td>${serie.codigo || ''}</td>
  <td>${serie.descripcion || ''}</td>
  <td>${serie.centro || ''}</td>
  <td>${serie.almacen || ''}</td>
  <td>${serie.lote || ''}</td>
  <td>${serie.nro_serie || ''}</td>
  <td>${serie.empresa || ''}</td>
  <td>${formatearFechaSegura(serie.fecha_ingreso)}</td>

  <td><input type="text" class="editable editable-estado_contrata" value="${(serie.estado_contrata || '').toUpperCase()}" 
    data-campo="estado_contrata" ${agregarKeys(serie)}></td>

  <td><input type="text" class="editable" value="${serie.sot || ''}" data-campo="sot" ${agregarKeys(serie)}></td>
  <td><input type="text" class="editable" value="${serie.cliente || ''}" data-campo="cliente" ${agregarKeys(serie)}></td>
  <td><input type="text" class="editable" value="${serie.id_devolucion || ''}" data-campo="id_devolucion" ${agregarKeys(serie)}></td>
  <td>${formatearFechaSegura(serie.fecha_estado_contrata)}</td>
  <td><input type="text" class="editable" value="${serie.comentario_contrata || ''}" data-campo="comentario_contrata" ${agregarKeys(serie)}></td>
  <td class="${claseColor}">${diasAntiguos !== null ? diasAntiguos + ' d√≠as' : ''}</td>
  <td><input type="text" class="editable" value="${serie.estado_soporte || ''}" data-campo="estado_soporte" ${agregarKeys(serie)}></td>
  <td><input type="text" class="editable" value="${serie.comentario_soporte || ''}" data-campo="comentario_soporte" ${agregarKeys(serie)}></td>
  <td>${formatearFechaSegura(serie.fecha_estado_soporte)}</td>
`;
    tbody.appendChild(fila);
  });

  ocultarLoader();
  actualizarControlesPaginacion(pagina, Math.ceil(count / tama√±oPagina));
}
</script>
  
  <script>
    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

 let tiempoEspera = null;

function filtrarTabla() {
  clearTimeout(tiempoEspera);
  const input = document.getElementById("searchInput").value.toLowerCase().trim();
  tiempoEspera = setTimeout(() => {
    cargarSeries(input, 0); // Siempre reiniciar desde p√°gina 0 al filtrar
  }, 300);
}


    function alternarOrden() {
  const boton = document.querySelector("button[onclick='alternarOrden()']");

  if (modoOrden === 'empresa') {
    modoOrden = 'antiguamiento';
    boton.innerHTML = '<i class="fas fa-sort-amount-down-alt"></i> Ordenar por Empresa';

    Swal.fire({
      icon: 'info',
      title: 'Ahora ordenando por antig√ºedad',
      text: 'Los equipos m√°s antiguos aparecer√°n primero.',
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#f39c12'
    });

  } else {
    modoOrden = 'empresa';
    boton.innerHTML = '<i class="fas fa-sort-amount-down-alt"></i> Ordenar por Antiguamiento';

    Swal.fire({
      icon: 'info',
      title: 'Ahora ordenando por empresa',
      text: 'Las series se mostrar√°n agrupadas por contratista.',
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#f39c12'
    });
  }

  cargarSeries(filtroActual, 0);
}
  </script>

  <script>
async function descargarExcelSeries() {
  mostrarLoader(); // üëà Mostrar
  const pageSize = 1000;
  let page = 0;
  let allData = [];
  let fetched = [];

  try {
    do {
      const { data, error } = await supabase
        .from('series_contrata')
        .select('*')
        .range(page * pageSize, (page + 1) * pageSize - 1);

      if (error) throw error;

      fetched = data;
      allData = allData.concat(fetched);
      page++;
    } while (fetched.length === pageSize);

    if (allData.length === 0) {
      console.warn("No se encontraron datos.");
      ocultarLoader();
      return;
    }

    const datos = allData.map(serie => ({
      C√≥digo: serie.codigo,
      Descripci√≥n: serie.descripcion,
      Centro: serie.centro,
      Almac√©n: serie.almacen,
      Lote: serie.lote,
      "N¬∞ Serie": serie.nro_serie,
      Empresa: serie.empresa,
      "Fecha Ingreso": formatearFechaSegura(serie.fecha_ingreso),
      "Estado Contrata": serie.estado_contrata,
      SOT: serie.sot,
      Cliente: serie.cliente,
      "ID Devoluci√≥n/Traspaso": serie.id_devolucion,
      "Fecha Estado Contrata": formatearFechaSegura(serie.fecha_estado_contrata),
      "Comentario Contrata": serie.comentario_contrata,
      Antiguamiento: calcularAntiguamiento(serie.fecha_ingreso) + ' d√≠as',      "Estado Soporte": serie.estado_soporte,
      "Comentario Soporte": serie.comentario_soporte,
      "Fecha Estado Soporte": formatearFechaSegura(serie.fecha_estado_soporte)
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(datos);
    XLSX.utils.book_append_sheet(wb, ws, "Series Contrata");
    XLSX.writeFile(wb, "Series_Contrata.xlsx");

          Swal.fire({
    icon: 'success',
    title: 'Excel generado',
    text: 'La descarga ha comenzado.',
    toast: true,
    position: 'bottom-end',
    showConfirmButton: false,
    timer: 2500,
    timerProgressBar: true,
    background: '#1e2022',
    color: '#ffffff',
    iconColor: '#11a24e'
  });

  } catch (error) {
    console.error("Error al exportar Excel:", error);
  } finally {
    ocultarLoader(); // üëà Siempre ocultar al final
  }
}
  </script>
  
<script>
async function procesarExcelSeries(file) {
  const reader = new FileReader();
  reader.onload = async (e) => {
    const workbook = XLSX.read(e.target.result, { type: 'binary' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet);

    for (const fila of data) {
      const campos = {
        sot: fila.SOT || '-',
        cliente: fila.Cliente || '-',
        id_devolucion: fila['ID Devoluci√≥n/Traspaso'] || '-',
        estado_contrata: (fila['Estado Contrata'] || '').toUpperCase(),
        comentario_contrata: fila['Comentario Contrata'] || '-',
        estado_soporte: fila['Estado Soporte'] || '-',
        comentario_soporte: fila['Comentario Soporte'] || '-'
      };

      // Validaciones
      if (['INSTALADO', 'RESERVADO'].includes(campos.estado_contrata)) {
        if (!fila.SOT || !fila.Cliente) continue; // omitir si no cumple
      }
      if (['DEVOLUCION', 'TRASPASO'].includes(campos.estado_contrata)) {
        if (!fila['ID Devoluci√≥n/Traspaso']) continue;
      }

      // Update Supabase
      const { error } = await supabase
        .from('series_contrata')
        .update(campos)
        .eq('codigo', fila.C√≥digo)
        .eq('centro', fila.Centro)
        .eq('almacen', fila['Almac√©n'])
        .eq('lote', fila.Lote)
        .eq('nro_serie', fila['N¬∞ Serie']);

      if (error) console.error(`Error al actualizar ${fila['N¬∞ Serie']}:`, error);
    }

    Swal.fire({
      icon: 'success',
      title: 'Plantilla cargada correctamente',
      toast: true,
      position: 'bottom-end',
      timer: 3000,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#11a24e'
    });

    cargarSeries(filtroActual, paginaActual); // refresca vista
  };

  reader.readAsBinaryString(file);
}
  </script>

  
  <script>
async function guardarCambios() {
  await cargarSeries(filtroActual, paginaActual);
  Swal.fire({
    icon: 'success',
    title: 'Cambios sincronizados',
    toast: true,
    position: 'bottom-end',
    showConfirmButton: false,
    timer: 2500,
    background: '#1e2022',
    color: '#ffffff',
    iconColor: '#11a24e'
  });
}
  </script>

<script>
const ESTADOS_VALIDOS = ["INSTALADO", "DISPONIBLE", "RESERVADO", "FACTURAR", "TRASPASO", "DEVOLUCI√ìN"];

document.addEventListener('change', async (e) => {
  const input = e.target;
  if (!input.classList.contains('editable')) return;

  const campo = input.dataset.campo;
  let valor = input.value.trim();

  // Validaci√≥n solo para estado_contrata
  if (campo === 'estado_contrata') {
    valor = valor.toUpperCase();
    input.value = valor;

    if (!ESTADOS_VALIDOS.includes(valor)) {
      input.style.backgroundColor = '#ffcccc';
      return;
    } else {
      input.style.backgroundColor = '';
    }
  }

  const { codigo, centro, almacen, lote, nro_serie } = input.dataset;
console.log('Valores para actualizar:', {
  campo, valor, codigo, centro, almacen, lote, nro_serie
});
  const { data, error } = await supabase
  .from('series_contrata')
  .update({ [campo]: valor })
  .eq('codigo', codigo)
  .eq('centro', centro)
  .eq('almacen', almacen)
  .eq('lote', lote)
  .eq('nro_serie', nro_serie)
  .select();  // üëà Esto fuerza a devolver los datos actualizados

  if (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: `No se pudo actualizar el campo ${campo}.`,
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 3000,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#f27474'
    });
  } else {
    Swal.fire({
      icon: 'success',
      title: El campo `${campo.replaceAll('_', ' ')} fue actualizado`,
      toast: true,
      position: 'bottom-end',
      showConfirmButton: false,
      timer: 2500,
      timerProgressBar: true,
      background: '#1e2022',
      color: '#ffffff',
      iconColor: '#11a24e'
    });
          // ‚úÖ Color temporal para indicar √©xito visual en el campo
    input.style.backgroundColor = '#d4edda'; // verde suave
    setTimeout(() => {
      input.style.backgroundColor = '';
    }, 1200);
 }
});
</script>
    
<script>
document.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter' && e.target.classList.contains('editable')) {
    e.preventDefault(); // evita salto de l√≠nea u otro comportamiento por defecto
    e.target.blur();    // forza el evento change
  }
});
</script>
  <script>
  document.addEventListener("DOMContentLoaded", () => cargarSeries(''));
</script>

  <script>
function paginaSiguiente() {
  cargarSeries(filtroActual, paginaActual + 1);
}

function paginaAnterior() {
  if (paginaActual > 0) {
    cargarSeries(filtroActual, paginaActual - 1);
  }
}

function actualizarControlesPaginacion(pagina, totalPaginas) {
  const info = document.getElementById("paginaInfo");
  info.textContent = `P√°gina ${pagina + 1} de ${totalPaginas}`;

  document.querySelector('#paginacion button:nth-child(1)').disabled = pagina <= 0;
  document.querySelector('#paginacion button:nth-child(3)').disabled = pagina + 1 >= totalPaginas;
}
</script>

  <script src="Js/Loader.js"></script>
  <script src="Js/Sesion.js"></script>
</body>
</html>
