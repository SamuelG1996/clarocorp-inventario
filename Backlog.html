<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Portal Inventario || Backlog </title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <link rel="icon" type="image/x-icon" href="Imagenes/favicon.ico">
</head>
<body class="menu-page formulario-traspaso backlog-page">
    <div class="content">
	  <div class="contenedor">
    
    <a href="/Compras" class="volver">
	      <i class="fas fa-arrow-left"></i> Volver a Compras
    </a>
	
    <h2><i class="fas fa-chart-bar"></i> Seguimiento de backlog</h2>

    <div class="acciones-tabla acciones-series">
      <button onclick="descargarExcel()">
        <i class="fas fa-file-excel"></i> Descargar Excel
      </button>
      </div>
 <div class="search-bar-paginacion">
  <input type="text" id="inputBuscar" placeholder="Buscar por código, descripción, SOT o cliente..." />
  <div class="paginacion">
    <button id="prevPage" onclick="cambiarPagina(-1)">Anterior</button>
    <span id="pageIndicator">Página 1</span>
    <button id="nextPage" onclick="cambiarPagina(1)">Siguiente</button>
  </div>
</div>

      <div class="tabla-scroll">
      <table id="tablaSeries">
        <thead>	
          <tr>
            <th>Proyecto</th>
            <th>SOT</th>
            <th>Estado SOT</th>
            <th>Cliente</th>
            <th>Tipo Trabajo</th>
            <th>Tipo Proyecto</th>
            <th>Sede</th>
            <th>Cantidad</th>
            <th>Descripción</th>
            <th>Código SAP</th>
            <th>Fecha Generación</th>
            <th>Fecha Compromiso</th>
	    <th>Estado Soporte</th>
	<th>Comentario Soporte</th>
	<th>Fecha Estado Soporte</th>  
          </tr>
        </thead>
        <tbody id="tablaBacklogBody">
          <!-- Se llenará dinámicamente -->
        </tbody>
      </table>
    </div>

  <script>
	
    const supabaseUrl = "https://bsrtuievwjtzwejuxqee.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzcnR1aWV2d2p0endlanV4cWVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1NTEyNjYsImV4cCI6MjA2NDEyNzI2Nn0.A9tCs-Zi-7jw5LUFs7ViIR2vHb9tNMj6c7YeeNOdmWI";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
	  
  document.addEventListener("DOMContentLoaded", () => {
    const tabla = document.getElementById("tablaBacklogBody");
    const inputBuscar = document.getElementById("inputBuscar");

    inputBuscar.addEventListener("input", () => {
      const filtro = inputBuscar.value.toLowerCase();
      const filas = tabla.getElementsByTagName("tr");

      for (let i = 0; i < filas.length; i++) {
        const textoFila = filas[i].textContent.toLowerCase();
        filas[i].style.display = textoFila.includes(filtro) ? "" : "none";
      }
    });

    function formatearFecha(fecha) {
      return fecha ? fecha.split("-").reverse().join("/") : "-";
    }
let paginaActual = 1;
const elementosPorPagina = 300;
    async function cargarBacklog(pagina = 1) {
  const desde = (pagina - 1) * elementosPorPagina;
  const hasta = desde + elementosPorPagina - 1;
        const { data, error } = await supabaseClient
    .from("backlog_compras")
    .select("*", { count: "exact" })
    .range(desde, hasta);

  if (error) {
    console.error("Error al obtener datos:", error);
    return;
  }

      tabla.innerHTML = "";

      data.forEach(item => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${item.proyecto || "-"}</td>
          <td>${item.codsolot || "-"}</td>
        <td class="estado_sot">${item.estado_sot || "-"}</td>
         <td class="cliente">${item.cliente || "-"}</td>
          <td>${item.tipotrabajo || "-"}</td>
          <td>${item.tipoproyecto || "-"}</td>
          <td class="sede">${item.sede || "-"}</td>
          <td>${item.cantidad ?? "-"}</td>
          <td class="descripcion">${item.descripcion || "-"}</td>
          <td>${item.nuevo_codigo || "-"}</td>
          <td>${formatearFecha(item.fecha_generacion)}</td>
          <td>${formatearFecha(item.fecha_compromiso)}</td>
	  <td>${item.estado_soporte || "PENDIENTE"}</td>
	<td>${item.comentario_soporte || "-"}</td>
	<td>${item.fecha_estado_soporte ? formatearFecha(item.fecha_estado_soporte.split("T")[0]) : "-"}</td>
        `;
        tabla.appendChild(fila);
      });
	    
  paginaActual = pagina;
  document.getElementById("pageIndicator").textContent = `Página ${pagina}`;
    }

	function descargarExcel() {
	  const tablaElement = document.getElementById("tablaSeries");
	  const wb = XLSX.utils.book_new();

	  // Convertir tabla HTML a una hoja de Excel
	  const ws = XLSX.utils.table_to_sheet(tablaElement, { raw: true });

	  // Agregar la hoja al libro de Excel
	  XLSX.utils.book_append_sheet(wb, ws, "Backlog");

	  // Descargar el archivo .xlsx
	  XLSX.writeFile(wb, "backlog_compras.xlsx");
	}

    // Asignar función al botón
    window.descargarExcel = descargarExcel;

    // Cargar datos al iniciar
    cargarBacklog();
  });
  </script>
  <script src="Js/Loader.js"></script>
  <script src="Js/Sesion.js"></script>
</body>
</html>
